<html>
  <head>
    <title>Game Multiplayer</title>
    <style>
      #screen {
        border: 10px solid #ccc;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        image-rendering: -moz-crisp-edges;
        width: 400px;
        height: 400px;
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <canvas id="screen" width="" height=""></canvas>
    <button class="movement-btn" data-movement="Up">Up</button>
    <button class="movement-btn" data-movement="Down">Down</button>
    <button class="movement-btn" data-movement="Right">Right</button>
    <button class="movement-btn" data-movement="Left">Left</button>
  </body>
  <script type="module">
    // melhorar código -> refactoring
    // adicionar mais testes automatizados

    import createKeyboardListener from "../keyboard-listener.js";
    import configureScreen from "../render-screen.js";
    import createGameClient from "../game-client.js";

    const gameClient = createGameClient();
    const socket = io();
    socket.on("connect", () => {
      console.log("> Conexão aberta com o server: ", socket.id);
    });

    const buttonMovementMap = {
      Up: "MoveUp",
      Down: "MoveDown",
      Right: "MoveRight",
      Left: "MoveLeft",
    };

    const playerMoved = (movement) => {
      console.log("> player moved", { movement });
      socket.emit("playerMoved", {
        playerId: socket.id,
        movement,
      });
    };

    socket.on("setup", (game) => {
      gameClient.setup({
        screen: game.state.screen,
        players: game.state.players,
        fruits: game.state.fruits,
      });

      const canvas = document.getElementById("screen");
      configureScreen(canvas, gameClient)(requestAnimationFrame);

      const movementButtons = document.querySelectorAll(".movement-btn");
      movementButtons.forEach((button) =>
        button.addEventListener("click", (event) => {
          playerMoved(buttonMovementMap[event.target.dataset.movement]);
        })
      );

      // SOLID
      // open closed principle

      const keyboardListener = createKeyboardListener(document);

      const keyboardMovementsMap = {
        38: "MoveUp",
        87: "MoveUp",

        40: "MoveDown",
        83: "MoveDown",

        37: "MoveLeft",
        65: "MoveLeft",

        39: "MoveRight",
        68: "MoveRight",
      };

      keyboardListener.subscribe((keyEvent) => {
        const movement = keyboardMovementsMap[keyEvent.keyCode];

        if (movement) {
          playerMoved(movement);
        }
      });

      socket.on("stateChanged", (state) => {
        gameClient.setup({
          screen: state.screen,
          players: state.players,
          fruits: state.fruits,
        });
      });
    });
  </script>
</html>
